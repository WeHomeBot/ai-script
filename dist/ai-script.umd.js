(function(n,s){typeof exports=="object"&&typeof module<"u"?s(exports):typeof define=="function"&&define.amd?define(["exports"],s):(n=typeof globalThis<"u"?globalThis:n||self,s(n.AIScript={}))})(this,function(n){"use strict";var S=Object.defineProperty;var C=(n,s,h)=>s in n?S(n,s,{enumerable:!0,configurable:!0,writable:!0,value:h}):n[s]=h;var p=(n,s,h)=>(C(n,typeof s!="symbol"?s+"":s,h),h);class s{constructor(e={}){p(this,"config");p(this,"initialized",!1);p(this,"CACHE_KEY","ai-script-cache");this.config={appKey:"",baseUrl:"https://api.deepseek.com",model:"deepseek-chat",debug:!1,enableCache:!0,cacheExpiration:30*24*60*60*1e3,...e},this.initFromScriptTag(),this.config.enableCache&&this.cleanExpiredCache()}getCacheFromStorage(){try{const e=localStorage.getItem(this.CACHE_KEY);return e?JSON.parse(e):{}}catch(e){return this.config.debug&&console.error("Failed to get cache from localStorage:",e),{}}}saveCacheToStorage(e){try{localStorage.setItem(this.CACHE_KEY,JSON.stringify(e)),this.config.debug&&console.log("Cache saved to localStorage")}catch(t){this.config.debug&&console.error("Failed to save cache to localStorage:",t)}}getCacheItem(e){return this.getCacheFromStorage()[e]}setCacheItem(e,t){const o={[e]:t};this.saveCacheToStorage(o)}cleanExpiredCache(){const e=this.getCacheFromStorage(),t=Date.now();let o=!1;for(const i in e)t-e[i].timestamp>(this.config.cacheExpiration||24*60*60*1e3)&&(delete e[i],o=!0);o&&(this.saveCacheToStorage(e),this.config.debug&&console.log("Expired cache items cleaned"))}initFromScriptTag(){const e=document.currentScript;if(!e)return;const t=e.getAttribute("appKey"),o=e.getAttribute("baseUrl"),i=e.getAttribute("model");t&&(this.config.appKey=t),o&&(this.config.baseUrl=o),i&&(this.config.model=i),this.config.debug&&console.log("AIScript initialized from script tag:",{appKey:this.config.appKey,baseUrl:this.config.baseUrl,model:this.config.model})}getDOMContext(){const e=document.body;let t=`Current page structure:
`;const o=(i,r=0)=>{var f;let c=`${" ".repeat(r*2)}<${i.tagName.toLowerCase()}`;if(i.id&&(c+=` id="${i.id}"`),i.className&&(c+=` class="${i.className}"`),c+=">",i.children.length===0){const a=(f=i.textContent)==null?void 0:f.trim();a&&(c+=` ${a}`)}c+=`
`;for(let a=0;a<i.children.length;a++)c+=o(i.children[a],r+1);return c};return t+=o(e),t}hashContext(e){let t=0;if(e.length===0)return"00000000000000000000000000000000";for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);t=(t<<5)-t+r,t=t&t}let o=(t>>>0).toString(16);for(;o.length<8;)o="0"+o;return o=o.repeat(4),o.slice(0,32)}findAIPrompts(){const e=[];return document.querySelectorAll('script[type="ai/prompt"]').forEach(o=>{var r;const i=(r=o.textContent)==null?void 0:r.trim();i&&e.push(i)}),e}dispatchAIScriptEvent(e,t){const o=new CustomEvent(e,{bubbles:!0,cancelable:!0,detail:t});document.dispatchEvent(o),this.config.debug&&console.log(`AIScript event dispatched: ${e}`,t)}async callAI(e,t){var o,i,r,g;try{if(!this.config.appKey)throw new Error("API Key is required");if(this.dispatchAIScriptEvent("ai-script-start",{prompt:t,timestamp:new Date().toISOString()}),this.config.enableCache){const l=`${this.hashContext(e)}_${t}`,d=this.getCacheItem(l),m=Date.now();if(d&&m-d.timestamp<(this.config.cacheExpiration||24*60*60*1e3))return this.config.debug&&console.log("Using cached AI response for prompt:",t),this.dispatchAIScriptEvent("ai-script-complete",{prompt:t,success:!0,hasCode:!!d.response.code,fromCache:!0,timestamp:new Date().toISOString()}),d.response}const c=await fetch(`${this.config.baseUrl}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.appKey}`},body:JSON.stringify({model:this.config.model,messages:[{role:"system",content:"You are a JavaScript expert. Generate only executable JavaScript code without explanations. The code should implement the functionality described in the user prompt, considering the current page structure."},{role:"user",content:`${e}

Prompt: ${t}

Generate JavaScript code to implement this functionality. Return ONLY the code without any explanations or markdown.`}]})});if(!c.ok)throw this.dispatchAIScriptEvent("ai-script-complete",{prompt:t,success:!1,error:`API request failed with status ${c.status}`,timestamp:new Date().toISOString()}),new Error(`API request failed with status ${c.status}`);const a=(g=(r=(i=(o=(await c.json()).choices)==null?void 0:o[0])==null?void 0:i.message)==null?void 0:r.content)==null?void 0:g.trim();if(this.dispatchAIScriptEvent("ai-script-complete",{prompt:t,success:!0,hasCode:!!a,timestamp:new Date().toISOString()}),this.config.enableCache){const l=`${this.hashContext(e)}_${t}`;this.setCacheItem(l,{response:{code:a},timestamp:Date.now()}),this.config.debug&&console.log("Cached AI response with key:",l)}return{code:a}}catch(c){return console.error("AI API call failed:",c),this.dispatchAIScriptEvent("ai-script-complete",{prompt:t,success:!1,error:c instanceof Error?c.message:String(c),timestamp:new Date().toISOString()}),{error:c instanceof Error?c.message:String(c)}}}executeCode(e){try{const t=document.createElement("script");t.textContent=e,document.head.appendChild(t),this.config.debug&&console.log("Executed AI-generated code:",e)}catch(t){console.error("Failed to execute AI-generated code:",t)}}async init(){if(this.initialized)return;this.initialized=!0;const e=this.getDOMContext(),t=this.findAIPrompts();if(t.length===0){this.config.debug&&console.log("No AI prompts found on the page");return}for(const o of t){const i=await this.callAI(e,o);i.code?this.executeCode(i.code):i.error&&this.config.debug&&console.error("AI code generation failed:",i.error)}}}if(typeof window<"u"){const h=new s;window.addEventListener("DOMContentLoaded",()=>{h.init().catch(e=>{console.error("AIScript initialization failed:",e)})})}n.AIScript=s,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
